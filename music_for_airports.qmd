---
title: "Music for Airports — A Data Visualization"
author: "Mark Johnson"
format: html
server: shiny
resources:
  - www
execute:
  echo: false
  warning: false
  message: false
---
```{css, echo=FALSE, results='asis'}
.hero {
  max-width: 900px;
  margin: 18px auto 12px;
  text-align: center;
  background: rgba(255,255,255,0.78);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  border: 1px solid rgba(255,255,255,0.35);
  border-radius: 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
  padding: 18px 24px;
}
.hero h1 {
  font-weight: 800;
  letter-spacing: 0.2px;
  margin: 0 0 8px 0;
}
.hero .lead {
  font-size: 1.08rem;
  line-height: 1.6;
  margin: 8px auto 2px;
  font-weight: 500;        /* slightly bolder */
  color: #111111;          /* deeper contrast text color */
  text-shadow:0 1px 2px rgba(255,255,255,0.6), 0 0 2px rgba(255,255,255,0.3);
}
.hero blockquote {
  font-style: italic;
  margin: 14px auto 0;
}
.meta {
  max-width: 900px;
  margin: 4px auto 18px;
  text-align: center;
  font-size: 0.9rem;
  color: #555;
}
.meta a { text-decoration: none; border-bottom: 1px dotted #888; }
.meta .label { font-weight: 700; color: #222; }
```

```{=html}
<div class="hero">
  <h1>Music for Airports — A Data Visualization</h1>

  <p class="lead">
    Released in <strong>1978</strong>, <em>Music for Airports</em> marked a turning point in how listeners understood sound and attention.
    Rather than a sequence of songs, it offered a spatial experience—music designed to shape the environment, not dominate it.
    Its minimalist structure and generative logic became foundational to what we now describe as ambient music.
  </p>

  <p class="lead">
    This dashboard approaches the album from a computational perspective. It extracts and visualizes key audio features—<strong>spectral centroid</strong>,
    <strong>spread</strong>, <strong>loudness</strong>, and <strong>stereo width</strong>—to show how the compositions evolve across time. The aim isn’t to
    interpret the music emotionally, but to reveal its architecture: the balance of movement and stasis, texture and silence.
  </p>

  <p class="lead">
    Inspired by <a href="https://committedtotape.shinyapps.io/sixtyninelovesongs/" target="_blank">Sixty-Nine Love Songs: The Data Visualization</a>,
    this project applies a similar framework to instrumental material, where patterns emerge not through words but through tone and resonance.
    It invites the viewer to consider <em>Music for Airports</em> as both data and design—an early algorithmic experiment rendered in analog form.
  </p>

  <blockquote>Ambient music must be as ignorable as it is interesting. - Eno</blockquote>
</div>

<div class="meta">
  <div><span class="label">Built by</span> Mark Johnson — with RStudio, Shiny, and Quarto.</div>
  <div><span class="label">R Packages:</span> shiny, ggplot2, plotly, dplyr, arrow, ggthemes.</div>
  <div><span class="label">Sources:</span> Audio features computed from local recordings of <em>Music for Airports</em>; inspired by the methods in
    <a href="https://committedtotape.shinyapps.io/sixtyninelovesongs/" target="_blank">committedtotape’s project</a>.
  </div>
</div>
```


```{r bg_css, echo=FALSE, results='asis'}
# Pick the file (works whether you kept it in www/ or next to the .qmd)
img_path <- if (file.exists("www/album_cover.jpg")) "www/album_cover.jpg" else "album_cover.jpg"

# Turn the image into a data URI (base64) so the browser always finds it
uri <- knitr::image_uri(img_path)

cat(sprintf('
<style>
  body{
    background: url("%s") center/cover no-repeat fixed;
    background-color: rgba(255,255,255,0.35);
    background-blend-mode: overlay;
  }
</style>', uri))
```





```{r setup, include=FALSE}
# ---- Libraries ----
library(shiny)
library(dplyr)
library(ggplot2)
library(plotly)
library(readr)

# ---- Load data ----
#if (file.exists("mfa_features.parquet")) {
#  feat <- read_parquet("mfa_features.parquet")
#} else {
#  feat <- read_csv("mfa_features.csv", show_col_types = FALSE)
#}

#feat <- feat %>%
#  mutate(
#    midpoint = (start_sec + end_sec) / 2,
#    track = factor(track, levels = unique(track))
#  )

feat <- tryCatch({
  if (file.exists("mfa_features.parquet") && requireNamespace("arrow", quietly = TRUE)) {
    arrow::read_parquet("mfa_features.parquet")
  } else {
    readr::read_csv("mfa_features.csv", show_col_types = FALSE)
  }
}, error = function(e) {
  # last-ditch fallback to CSV
  readr::read_csv("mfa_features.csv", show_col_types = FALSE)
})

feat <- feat %>%
  mutate(
    midpoint = (start_sec + end_sec) / 2,
    track = factor(track, levels = unique(track))
  )



img_path <- if (file.exists("www/album_cover.jpg")) {
  "www/album_cover.jpg"
} else if (file.exists("album_cover.jpg")) {
  "album_cover.jpg"
} else {
  NA_character_
}
bg_uri <- if (!is.na(img_path)) knitr::image_uri(img_path) else NA_character_

# mp3 finding code

# ---- Serve static files via a Shiny resource path ----
if (dir.exists("www")) {
  shiny::addResourcePath("mfa", normalizePath("www"))
} else {
  dir.create("www")
  shiny::addResourcePath("mfa", normalizePath("www"))
}

# Prefer MP3s in www/, else look in project root and copy the first one into www/
mp3s_www  <- list.files("www", pattern = "\\.mp3$", full.names = TRUE)
mp3s_root <- list.files(".",   pattern = "\\.mp3$", full.names = TRUE)

if (!length(mp3s_www) && length(mp3s_root)) {
  file.copy(mp3s_root[1], file.path("www", basename(mp3s_root[1])), overwrite = TRUE)
  mp3s_www <- list.files("www", pattern = "\\.mp3$", full.names = TRUE)
}

mp3_first <- if (length(mp3s_www)) mp3s_www[order(basename(mp3s_www))][1] else NA_character_

# Browser path served by Shiny via 'mfa' prefix (DO NOT include "www/")
mp3_src <- if (!is.na(mp3_first)) paste0("mfa/", basename(mp3_first)) else NA_character_

# ---- Plain-English feature descriptions ----
feature_labels <- c(
  centroid_hz  = "Spectral centroid: a proxy for perceived brightness. Higher = more energy in higher frequencies (brighter timbre).",
  spread_hz    = "Spectral spread: how widely energy is distributed around the centroid. Higher = broader, noisier spectrum; lower = tighter, purer tone.",
  skewness     = "Spectral skewness: asymmetry of the spectrum around its center. Positive = more high-frequency tail; negative = more low-frequency tail.",
  kurtosis     = "Spectral kurtosis: ‘peakedness’ of the spectrum. High = sharp, narrow peaks; low = flatter, more even spectrum.",
  rms          = "Loudness (RMS): average signal power over a window. Higher = louder passage; lower = quieter passage.",
  stereo_width = "Stereo width: correlation/energy difference between left and right. Higher = wider image; lower = more mono/centered."
)

# visual

library(scales)   # for alpha()

# Palette mapped to your track labels (edit if labels differ)
track_levels <- levels(feat$track)
pal_tracks <- setNames(
  c("#2D728F",  # deep teal
    "#5C8D57",  # olive green
    "#8A7BBD",  # lavender
    "#D96B52"   # warm coral
  )[seq_along(track_levels)],
  track_levels
)

# A soft theme that plays nicely with the background
mfa_theme <- theme_minimal(base_size = 13) +
  theme(
    panel.background = element_rect(fill = alpha("white", 0.78), color = NA),
    plot.background  = element_rect(fill = NA, color = NA),
    panel.grid.major = element_line(color = alpha("grey20", 0.18), linewidth = 0.25),
    panel.grid.minor = element_blank(),
    axis.title       = element_text(color = "#0f0f0f"),
    axis.text        = element_text(color = "#222"),
    legend.position  = "right",
    legend.background= element_blank(),
    plot.title       = element_text(face = "bold")
  )


```

```{r shiny_ui}
# ---- Shiny UI ----
ui <- fluidPage(

  # ---- Background image CSS (from bg_uri) ----
  if (!is.na(bg_uri)) {
    tags$head(
      tags$style(HTML(sprintf("
        body{
          background: url('%s') center/cover no-repeat fixed !important;
          background-color: rgba(255,255,255,0.35) !important;
          background-blend-mode: overlay !important;
        }
      ", bg_uri)))
    )
  },

  # ---- JS: attempt autoplay; unmute on first user interaction ----
  tags$head(
    tags$script(HTML("
      document.addEventListener('DOMContentLoaded', function(){
        const a = document.getElementById('mfa_player');
        if (!a) return;
        const tryPlay = () => { const p = a.play(); if (p) p.catch(()=>{}); };
        tryPlay();
        const unmute = () => { 
          a.muted = false; 
          a.play().catch(()=>{}); 
          document.removeEventListener('click', unmute);
          document.removeEventListener('keydown', unmute); 
        };
        document.addEventListener('click', unmute, { once: true });
        document.addEventListener('keydown', unmute, { once: true });
      });
    "))
  ),

  # ---- Audio element in the BODY (uses Shiny resource path 'mfa/') ----
  if (!is.na(mp3_src)) {
    tagList(
      tags$audio(
        id = "mfa_player",
        src = mp3_src,          # e.g., "mfa/01 - 1-1.mp3"
        autoplay = NA,
        muted = NA,
        controls = NA,
        preload = "auto",
        `playsinline` = NA,
        style = "width:100%; max-width:480px; display:block; margin:8px 0;"
      ),
      # tiny debug link (remove later if you want)
      tags$p(style="font-size:12px;opacity:.6;",
             "Audio src: ", tags$a(href = mp3_src, mp3_src, target = "_blank"))
    )
  },

  # ---- HERO INTRO (centered, glass card) ----
  tags$div(class = "hero",
    tags$h1("Music for Airports — A Data Visualization"),
    tags$p(class = "lead",
      HTML('Released in <strong>1978</strong>, <em>Music for Airports</em> marked a turning point in how listeners understood sound and attention.
      Rather than a traditional sequence of songs, it offered a spatial experience—music designed to shape the environment, not dominate it.
      Its minimalist structure and generative logic became foundational to what we now describe as ambient music.')
    ),
    tags$p(class = "lead",
      HTML('This dashboard approaches the album from a computational perspective. It extracts and visualizes audio features to show how the the compositions making up <em>Music for Airports</em> evolve across time and in relation to one another.')
    ),
    tags$p(class = "lead",
      HTML('Inspired by <a href="https://committedtotape.shinyapps.io/sixtyninelovesongs/" target="_blank">Sixty-Nine Love Songs: The Data Visualization</a>,
      this project applies a similar framework to instrumental material, where patterns emerge not through words but through tone and resonance.
      It invites the viewer to explore <em>Music for Airports</em> through visual patterns.')
    ),
    tags$blockquote("Ambient music must be as ignorable as it is interesting. - Eno")
  ),

  # ---- META line (packages/sources) ----
  tags$div(class = "meta",
    tags$div(HTML('<span class="label">Built by</span> Created by Mark Johnson — with RStudio, Shiny, and Quarto.')),
    tags$div(HTML('<span class="label">R Packages:</span> shiny, ggplot2, plotly, dplyr, arrow, ggthemes.')),
    tags$div(HTML('<span class="label">Sources:</span> Audio features computed from local recordings of <em>Music for Airports</em>; inspired by the methods in
      <a href="https://committedtotape.shinyapps.io/sixtyninelovesongs/" target="_blank">committedtotape’s project</a>.'))
  ),

  # ---- MAIN APP CONTENT ----
  sidebarLayout(
    sidebarPanel(
      selectInput("track", "Track:", c("All", levels(feat$track))),
      selectInput("feature", "Feature:",
        c("Centroid (Hz)"="centroid_hz","Spread (Hz)"="spread_hz",
          "Skewness"="skewness","Kurtosis"="kurtosis",
          "Loudness (RMS)"="rms","Stereo width"="stereo_width")),
      sliderInput("range","Time range (sec):",
        min=floor(min(feat$start_sec, na.rm=TRUE)),
        max=ceiling(max(feat$end_sec,  na.rm=TRUE)),
        value=c(floor(min(feat$start_sec)), ceiling(max(feat$end_sec))),
        step=10),
      checkboxInput("smooth","Smooth curve", TRUE)
    ),
    mainPanel(
      uiOutput("feat_desc"),
      tabsetPanel(
        tabPanel("Timeline",     plotlyOutput("timeline", height="400px")),
        tabPanel("Distribution", plotlyOutput("hist",     height="400px")),
        tabPanel("Comparison",   plotlyOutput("box",      height="400px"))
      )
    )
  )
)

```

```{r shiny_server}
server <- function(input, output, session) {

  # Plain-English description for the selected feature
  output$feat_desc <- renderUI({
    key <- input$feature
    txt <- feature_labels[[key]]
    if (is.null(txt)) return(NULL)
    tags$p(
      style = "margin:12px auto 8px; max-width:800px; text-align:center;
               font-size:1.4rem; color:#222;
               background:rgba(255,255,255,0.75); border-radius:10px;
               padding:10px 14px; border:1px solid rgba(0,0,0,0.05);
               box-shadow:0 3px 8px rgba(0,0,0,0.05);",
      txt
    )
  })

  # Reactive filter
  filt <- reactive({
    df <- feat
    if (input$track != "All") df <- dplyr::filter(df, track == input$track)
    dplyr::filter(df, midpoint >= input$range[1], midpoint <= input$range[2])
  })

  # Timeline
  output$timeline <- renderPlotly({
    df <- filt()
    p <- ggplot(df, aes(x = midpoint, y = .data[[input$feature]], color = track)) +
      geom_line(alpha = 0.8, linewidth = 0.7) +
      { if (input$smooth) geom_smooth(se = FALSE, span = 0.2, linewidth = 0.6, color = "#333333") } +
      scale_color_manual(values = pal_tracks, guide = guide_legend(title = "track")) +
      labs(x = "Time (s)", y = input$feature, title = "Feature trajectory over time") +
      mfa_theme

    ggplotly(p) %>%
      layout(
        paper_bgcolor = "rgba(0,0,0,0)",
        plot_bgcolor  = "rgba(255,255,255,0.78)",
        legend = list(bgcolor = "rgba(0,0,0,0)")
      )
  })

  # Distribution
  output$hist <- renderPlotly({
    df <- filt()
    p <- ggplot(df, aes(x = .data[[input$feature]], fill = track)) +
      geom_histogram(bins = 40, alpha = 0.55, color = "white", linewidth = 0.2, position = "identity") +
      scale_fill_manual(values = pal_tracks, guide = guide_legend(title = "track")) +
      labs(x = input$feature, y = "Count", title = "Distribution of values") +
      mfa_theme

    ggplotly(p) %>%
      layout(
        paper_bgcolor = "rgba(0,0,0,0)",
        plot_bgcolor  = "rgba(255,255,255,0.78)",
        legend = list(bgcolor = "rgba(0,0,0,0)")
      )
  })

  # Comparison
  output$box <- renderPlotly({
    p <- ggplot(feat, aes(x = track, y = .data[[input$feature]], fill = track)) +
      geom_boxplot(alpha = 0.7, outlier.size = 0.8, color = scales::alpha("black", 0.25)) +
      scale_fill_manual(values = pal_tracks, guide = "none") +
      labs(x = NULL, y = input$feature, title = "Feature comparison across tracks") +
      mfa_theme +
      theme(axis.text.x = element_text(angle = 30, hjust = 1))

    ggplotly(p) %>%
      layout(
        paper_bgcolor = "rgba(0,0,0,0)",
        plot_bgcolor  = "rgba(255,255,255,0.78)"
      )
  })
}

#shinyApp(ui, server)

```

